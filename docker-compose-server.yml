# Example: Production-like deployment serving API and SPA over HTTPS via the Frontend container
# - The Angular Frontend (nginx) terminates TLS on 443 and proxies /api to the FastAPI server
# - TLS certificates are provided by the HOST system at ./certs (or self-signed generated in container)
# - No separate reverse proxy service is required
#
# Requirements:
#   - Provide your certificate and key on the host at ./certs/tls.crt and ./certs/tls.key
#     (Or rely on the frontend container to generate a self-signed cert if not present.)
#
# Usage:
#   DOMAIN=nebula.local docker compose -f docker-compose-server.yml up -d --build

services:
  server:
    image: ghcr.io/kumpeapps/managed-nebula/server:latest
    environment:
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - DB_URL=${DB_URL:-sqlite+aiosqlite:///./data/app.db}
      - SECRET_KEY=${SECRET_KEY:-change-me}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - ENABLE_SCHEMA_AUTOSYNC=${ENABLE_SCHEMA_AUTOSYNC:-true}
    expose:
      - "8080"
    volumes:
      - server_data:/app/data
    restart: unless-stopped
    networks:
      - nebula
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/api/v1/healthz"]
      interval: 15s
      timeout: 5s
      retries: 10

  frontend:
    image: ghcr.io/kumpeapps/managed-nebula/frontend:latest
    depends_on:
      - server
    environment:
      - SSL_CERT_NAME=${SSL_CERT_NAME:-tls.crt}
      - SSL_KEY_NAME=${SSL_KEY_NAME:-tls.key}
      - DOMAIN=${DOMAIN:-localhost}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs:/etc/nginx/certs:ro
    restart: unless-stopped
    networks:
      - nebula
    healthcheck:
      test: ["CMD-SHELL", "curl -skf https://localhost/api/v1/healthz >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5


networks:
  nebula:
    driver: bridge

volumes:
  server_data:
