name: Push Latest Release as kumpeapps
permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  tag-latest-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest release tag
        id: latest_release
        run: |
          set -euo pipefail

          RELEASE_TAG=$(curl -fsSL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | jq -r '.tag_name')

          if [[ -z "$RELEASE_TAG" || "$RELEASE_TAG" == "null" ]]; then
            echo "::error::Could not determine latest release tag"
            exit 1
          fi

          echo "Latest release tag: $RELEASE_TAG"
          echo "tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

      - name: Retag server image as kumpeapps
        run: |
          set -euo pipefail
          SRC="${{ env.REGISTRY }}/${{ github.repository }}/server:${{ steps.latest_release.outputs.tag }}"
          DST="${{ env.REGISTRY }}/${{ github.repository }}/server:kumpeapps"
          docker buildx imagetools create --tag "$DST" "$SRC"

      - name: Retag frontend image as kumpeapps
        run: |
          set -euo pipefail
          SRC="${{ env.REGISTRY }}/${{ github.repository }}/frontend:${{ steps.latest_release.outputs.tag }}"
          DST="${{ env.REGISTRY }}/${{ github.repository }}/frontend:kumpeapps"
          docker buildx imagetools create --tag "$DST" "$SRC"

      - name: Retag client image as kumpeapps
        run: |
          set -euo pipefail
          SRC="${{ env.REGISTRY }}/${{ github.repository }}/client:${{ steps.latest_release.outputs.tag }}"
          DST="${{ env.REGISTRY }}/${{ github.repository }}/client:kumpeapps"
          docker buildx imagetools create --tag "$DST" "$SRC"

      - name: Summary
        run: |
          echo "Tagged latest release (${{ steps.latest_release.outputs.tag }}) as :kumpeapps for server, frontend, and client images."
