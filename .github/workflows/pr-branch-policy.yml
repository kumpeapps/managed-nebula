name: PR Branch Policy
permissions:
  contents: read
on:
  pull_request:
    branches: [ dev, main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate branch, base, and title
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PR metadata
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF="${{ github.base_ref }}"
          HEAD_REF="${{ github.head_ref }}"
          TITLE="${{ github.event.pull_request.title }}"

          echo "Base: $BASE_REF"
          echo "Head: $HEAD_REF"
          echo "Title: $TITLE"

          # Allow both manual branches and Copilot-generated branches
          branch_regex='^((feature|bugfix|hotfix|docs|refactor)/(server|frontend|client|all)-[0-9]+|copilot/.*)$'

          if [[ "$BASE_REF" != "dev" ]]; then
            echo "::error::Pull requests must target 'dev' branch (found '$BASE_REF')." >&2
            exit 1
          fi

          if [[ ! "$HEAD_REF" =~ $branch_regex ]]; then
            echo "::error::Head branch '$HEAD_REF' does not match required pattern: $branch_regex" >&2
            exit 1
          fi

          required_prefix="[$HEAD_REF] "
          if [[ "$TITLE" != "$required_prefix"* ]]; then
            echo "::error::PR title must start with '[${HEAD_REF}] '." >&2
            echo "Suggested: [${HEAD_REF}] Concise description" >&2
            exit 1
          fi

          echo "PR checks passed."
