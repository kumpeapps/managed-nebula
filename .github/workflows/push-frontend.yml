name: Push Frontend Image to Harbor
permissions:
  contents: read

on:
  push:
    branches: [ dev, main ]
    tags: [ 'v*' ]
    paths:
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/push-frontend.yml'
  release:
    types: [published]
  workflow_dispatch:

env:
  DOCKER_CLIENT_TIMEOUT: 300
  COMPOSE_HTTP_TIMEOUT: 300

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push-frontend:
    # On releases: run if title has "frontend" (any case) or no platform keywords specified
    if: >
      github.event_name != 'release' || (
        contains(github.event.release.name, 'frontend') || contains(github.event.release.name, 'Frontend') || (
          !contains(github.event.release.name, 'windows') && !contains(github.event.release.name, 'Windows') &&
          !contains(github.event.release.name, 'macos') && !contains(github.event.release.name, 'macOS') &&
          !contains(github.event.release.name, 'server') && !contains(github.event.release.name, 'Server') &&
          !contains(github.event.release.name, 'frontend') && !contains(github.event.release.name, 'Frontend') &&
          !contains(github.event.release.name, 'client') && !contains(github.event.release.name, 'Client')
        )
      )
    timeout-minutes: 120
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Preflight - Harbor DNS and TLS reachability
        run: |
          set -x
          getent hosts harbor.vm.kumpeapps.com || true
          nslookup harbor.vm.kumpeapps.com || true
          curl -vkI --max-time 15 https://harbor.vm.kumpeapps.com/v2/ || true

      - name: Set up QEMU (multi-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Harbor (with retry)
        run: |
          for i in 1 2 3; do
            echo "${{ secrets.HARBOR_SECRET }}" | docker login harbor.vm.kumpeapps.com -u "robot_github" --password-stdin && exit 0
            echo "Login failed (attempt $i), retrying in 5s...";
            sleep 5;
          done
          echo "Failed to login to Harbor after 3 attempts" >&2
          exit 1

      - name: Get Latest Release Version
        id: get_version
        run: |
          # Handle both branches and tags
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # For tags, use the tag as version
            LATEST_RELEASE="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: ${LATEST_RELEASE}"
          else
            # For branches, find latest release
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            echo "Current branch: ${BRANCH_NAME}"
            
            # Fetch releases with error handling
            RELEASES_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/kumpeapps/managed-nebula/releases)
            
            # Check if we got valid JSON
            if echo "$RELEASES_JSON" | jq -e . >/dev/null 2>&1; then
              LATEST_RELEASE=$(echo "$RELEASES_JSON" | jq -r --arg branch "$BRANCH_NAME" '[
                .[] | select(.target_commitish == $branch or .target_commitish == "main")
              ] | .[0].tag_name // "v1.0.0"')
            else
              echo "Warning: Failed to fetch releases from GitHub API, using default version"
              LATEST_RELEASE="v1.0.0"
            fi
            
            echo "Latest release version for ${BRANCH_NAME}: ${LATEST_RELEASE}"
          fi
          
          echo "latest_version=${LATEST_RELEASE}" >> $GITHUB_OUTPUT

      - name: Build and Push Image (dev-latest)
        if: github.ref == 'refs/heads/dev'
        run: |
          docker buildx build --push \
            --build-arg VERSION=${{ steps.get_version.outputs.latest_version }} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:dev-latest \
            --cache-from type=gha,scope=frontend-dev \
            --cache-to type=gha,mode=max,scope=frontend-dev \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:dev-latest \
            --provenance=false \
            --platform linux/amd64,linux/arm64 ./frontend

      - name: Build and Push Image (latest)
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx build --push \
            --build-arg VERSION=${{ steps.get_version.outputs.latest_version }} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
            --cache-from type=gha,scope=frontend-main \
            --cache-to type=gha,mode=max,scope=frontend-main \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
            --provenance=false \
            --platform linux/amd64,linux/arm64 ./frontend

      - name: Build and Push Image (tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          
          # Check if this is a pre-release tag (contains alpha, beta, or rc)
          if [[ "$TAG_NAME" =~ (alpha|beta|rc) ]]; then
            echo "::notice::Pre-release tag detected ($TAG_NAME) - pushing version tag only"
            PUSH_LATEST=false
          elif [[ "${{ github.event_name }}" == "release" ]] && [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "::notice::Pre-release detected via GitHub release - pushing version tag only"
            PUSH_LATEST=false
          else
            echo "::notice::Stable release tag detected ($TAG_NAME) - pushing version and :latest tags"
            PUSH_LATEST=true
          fi
          
          # Build tags based on release type
          if [ "$PUSH_LATEST" = true ]; then
            echo "Building and pushing tags: $TAG_NAME and latest"
            docker buildx build --push \
              --build-arg VERSION="$TAG_NAME" \
              --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:"$TAG_NAME" \
              --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
              --cache-from type=gha,scope=frontend-main \
              --cache-to type=gha,mode=max,scope=frontend-tag \
              --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
              --provenance=false \
              --platform linux/amd64,linux/arm64 ./frontend
          else
            echo "Building and pushing version tag only: $TAG_NAME"
            docker buildx build --push \
              --build-arg VERSION="$TAG_NAME" \
              --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:"$TAG_NAME" \
              --cache-from type=gha,scope=frontend-main \
              --cache-to type=gha,mode=max,scope=frontend-tag \
              --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
              --provenance=false \
              --platform linux/amd64,linux/arm64 ./frontend
          fi
