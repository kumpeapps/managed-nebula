name: Push Frontend Image to Harbor
permissions:
  contents: read

on:
  push:
    branches: [ dev, main ]
    tags: [ 'v*' ]
    paths:
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/push-frontend.yml'
  release:
    types: [published]
  workflow_dispatch:

env:
  DOCKER_CLIENT_TIMEOUT: 300
  COMPOSE_HTTP_TIMEOUT: 300
  # Multi-arch: For dev/main branches, build AMD64 only (fast). For tags/releases, build both architectures.
  # ARM64 emulation on self-hosted runner has network timeouts during npm ci (~19 min vs 40s for AMD64)
  BUILD_PLATFORMS_DEV: "linux/amd64"
  BUILD_PLATFORMS_RELEASE: "linux/amd64,linux/arm64"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-frontend:
    # Build on GitHub's hosted runners (better ARM64 emulation)
    if: >
      github.event_name != 'release' || (
        contains(github.event.release.name, 'frontend') || contains(github.event.release.name, 'Frontend') || (
          !contains(github.event.release.name, 'windows') && !contains(github.event.release.name, 'Windows') &&
          !contains(github.event.release.name, 'macos') && !contains(github.event.release.name, 'macOS') &&
          !contains(github.event.release.name, 'server') && !contains(github.event.release.name, 'Server') &&
          !contains(github.event.release.name, 'frontend') && !contains(github.event.release.name, 'Frontend') &&
          !contains(github.event.release.name, 'client') && !contains(github.event.release.name, 'Client')
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      version: ${{ steps.get_version.outputs.latest_version }}
      branch: ${{ steps.get_version.outputs.branch_name }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up QEMU (multi-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get Latest Release Version
        id: get_version
        run: |
          # Handle both branches and tags
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # For tags, use the tag as version
            LATEST_RELEASE="${GITHUB_REF#refs/tags/}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            BRANCH_NAME=""
            echo "Triggered by tag: ${LATEST_RELEASE}"
          else
            # For branches, find latest release
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            TAG_NAME=""
            echo "Current branch: ${BRANCH_NAME}"
            
            LATEST_RELEASE=$(curl -s https://api.github.com/repos/kumpeapps/managed-nebula/releases | \
              jq -r --arg branch "$BRANCH_NAME" '[
                .[] | select(.target_commitish == $branch or .target_commitish == "main")
              ] | .[0].tag_name // "v1.0.0"')
            
            echo "Latest release version for ${BRANCH_NAME}: ${LATEST_RELEASE}"
          fi
          
          echo "latest_version=${LATEST_RELEASE}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Build Multi-arch Images (with GitHub cache)
        run: |
          # Determine platforms and cache scope based on ref
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            PLATFORMS="$BUILD_PLATFORMS_RELEASE"
            CACHE_SCOPE="frontend-tag"
            echo "Building RELEASE multi-arch for platforms: $PLATFORMS"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            PLATFORMS="$BUILD_PLATFORMS_DEV"
            CACHE_SCOPE="frontend-main"
            echo "Building MAIN (AMD64 only) for platforms: $PLATFORMS"
          else
            PLATFORMS="$BUILD_PLATFORMS_DEV"
            CACHE_SCOPE="frontend-dev"
            echo "Building DEV (AMD64 only) for platforms: $PLATFORMS"
          fi
          
          echo "Images will be cached and pushed from self-hosted runner with Harbor access"
          
          docker buildx build \
            --build-arg VERSION=${{ steps.get_version.outputs.latest_version }} \
            --cache-from type=gha,scope=${CACHE_SCOPE} \
            --cache-to type=gha,mode=max,scope=${CACHE_SCOPE} \
            --platform $PLATFORMS \
            ./frontend
          
          echo "âœ… Build completed and cached. Self-hosted runner will push to Harbor."

  push-to-harbor:
    # Push on self-hosted runner (has Harbor network access)
    needs: build-frontend
    runs-on: vm-prod-github-runner
    timeout-minutes: 30
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Preflight - Harbor DNS and TLS reachability
        run: |
          set -x
          getent hosts harbor.vm.kumpeapps.com || true
          nslookup harbor.vm.kumpeapps.com || true
          curl -vkI --max-time 15 https://harbor.vm.kumpeapps.com/v2/ || true

      - name: Set up QEMU (multi-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Harbor (with retry)
        run: |
          for i in 1 2 3; do
            echo "${{ secrets.HARBOR_SECRET }}" | docker login harbor.vm.kumpeapps.com -u "robot_github" --password-stdin && exit 0
            echo "Login failed (attempt $i), retrying in 5s...";
            sleep 5;
          done
          echo "Failed to login to Harbor after 3 attempts" >&2
          exit 1

      - name: Push Image (dev-latest)
        if: needs.build-frontend.outputs.branch == 'dev'
        run: |
          echo "Pushing dev-latest (AMD64 only) to Harbor using cached build from GitHub runner"
          docker buildx build --push \
            --build-arg VERSION=${{ needs.build-frontend.outputs.version }} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:dev-latest \
            --cache-from type=gha,scope=frontend-dev \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:dev-latest \
            --provenance=false \
            --platform $BUILD_PLATFORMS_DEV ./frontend

      - name: Push Image (latest)
        if: needs.build-frontend.outputs.branch == 'main'
        run: |
          echo "Pushing latest (AMD64 only) to Harbor using cached build from GitHub runner"
          docker buildx build --push \
            --build-arg VERSION=${{ needs.build-frontend.outputs.version }} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
            --cache-from type=gha,scope=frontend-main \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
            --provenance=false \
            --platform $BUILD_PLATFORMS_DEV ./frontend

      - name: Push Image (tag)
        if: needs.build-frontend.outputs.tag_name != ''
        run: |
          TAG_NAME="${{ needs.build-frontend.outputs.tag_name }}"
          
          # Check if this is a pre-release tag (contains alpha, beta, or rc)
          if [[ "$TAG_NAME" =~ (alpha|beta|rc) ]]; then
            echo "::notice::Pre-release tag detected ($TAG_NAME) - pushing version tag only"
            PUSH_LATEST=false
          elif [[ "${{ github.event_name }}" == "release" ]] && [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "::notice::Pre-release detected via GitHub release - pushing version tag only"
            PUSH_LATEST=false
          else
            echo "::notice::Stable release tag detected ($TAG_NAME) - pushing version and :latest tags"
            PUSH_LATEST=true
          fi
          
          echo "Pushing tagged image (MULTI-ARCH) to Harbor using cached build from GitHub runner"
          # Build tags based on release type
          if [ "$PUSH_LATEST" = true ]; then
            echo "Pushing tags: $TAG_NAME and latest (AMD64 + ARM64)"
            docker buildx build --push \
              --build-arg VERSION="$TAG_NAME" \
              --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:"$TAG_NAME" \
              --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
              --cache-from type=gha,scope=frontend-tag \
              --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
              --provenance=false \
              --platform $BUILD_PLATFORMS_RELEASE ./frontend
          else
            echo "Pushing version tag only: $TAG_NAME (AMD64 + ARM64)"
            docker buildx build --push \
              --build-arg VERSION="$TAG_NAME" \
              --tag harbor.vm.kumpeapps.com/managed-nebula/frontend:"$TAG_NAME" \
              --cache-from type=gha,scope=frontend-tag \
              --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/frontend:latest \
              --provenance=false \
              --platform $BUILD_PLATFORMS_RELEASE ./frontend
          fi
