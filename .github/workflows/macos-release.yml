name: Build and Release macOS Client

on:
  release:
    types: [published]

jobs:
  build:
    # Run if title has "macos" (any case) or no platform keywords specified
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' &&
        (
          contains(github.event.release.name, 'macos') ||
          contains(github.event.release.name, 'macOS') ||
          (
            !contains(github.event.release.name, 'windows') &&
            !contains(github.event.release.name, 'Windows') &&
            !contains(github.event.release.name, 'macos') &&
            !contains(github.event.release.name, 'macOS') &&
            !contains(github.event.release.name, 'server') &&
            !contains(github.event.release.name, 'Server') &&
            !contains(github.event.release.name, 'frontend') &&
            !contains(github.event.release.name, 'Frontend') &&
            !contains(github.event.release.name, 'client') &&
            !contains(github.event.release.name, 'Client')
          )
        )
      )
    permissions:
      contents: write
    runs-on: macos-latest
    env:
      CI: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.MACOS_RELEASE_DEPLOY_KEY }}
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: macos_client
    
    - name: Install Fastlane
      run: |
        cd macos_client
        gem install fastlane
    
    - name: Setup SSH key for Fastlane Match
      env:
        MATCH_DEPLOY_KEY: ${{ secrets.MACOS_RELEASE_DEPLOY_KEY }}
      run: |
        # Setup SSH key for Match certificates repo
        mkdir -p ~/.ssh
        echo "$MATCH_DEPLOY_KEY" > ~/.ssh/match_deploy_key
        chmod 600 ~/.ssh/match_deploy_key
        
        # Add GitHub to known hosts
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        
        # Configure SSH to use the deploy key for Match repo
        cat >> ~/.ssh/config <<EOF
        Host github.com-match
          HostName github.com
          User git
          IdentityFile ~/.ssh/match_deploy_key
          IdentitiesOnly yes
        EOF
        
        # Configure git for match
        git config --global user.email "ci@kumpeapps.com"
        git config --global user.name "GitHub Actions"
    
    - name: Get version from release tag
      id: get_version
      run: |
        # Extract version from release tag (strip 'v' prefix, keep beta suffixes)
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Build and Sign with Fastlane
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
        MATCH_GIT_PRIVATE_KEY: ${{ secrets.MACOS_RELEASE_DEPLOY_KEY }}
        APPLE_APPSTORE_API_ISSUER_ID: ${{ secrets.APPLE_APPSTORE_API_ISSUER_ID }}
        APPLE_APP_STORE_API_KEY: ${{ secrets.APPLE_APP_STORE_API_KEY }}
        APPLE_APP_STORE_API_KEY_ID: ${{ secrets.APPLE_APP_STORE_API_KEY_ID }}
        VERSION: ${{ steps.get_version.outputs.VERSION }}
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_USER: "jakumpe@justinkumpe.net"

      run: |
        cd macos_client
        fastlane mac build_production
    
    - name: Verify notarization
      run: |
        cd macos_client
        spctl -a -vv -t install dist/ManagedNebula-macos-${{ steps.get_version.outputs.VERSION }}-signed.pkg
        xcrun stapler validate dist/ManagedNebula-macos-${{ steps.get_version.outputs.VERSION }}-signed.pkg
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          macos_client/dist/*-signed.pkg
          macos_client/dist/*-signed.dmg
        body: |
          # ManagedNebula macOS Client ${{ steps.get_version.outputs.VERSION }}
          
          ## Installation Options
          
          ### PKG Installer (Recommended)
          - Complete installation with Nebula binaries and LaunchDaemon
          - Download: `ManagedNebula-macos-${{ steps.get_version.outputs.VERSION }}-signed.pkg`
          - Double-click to install
          
          ### DMG Installer
          - For users who already have Nebula via Homebrew
          - Download: `ManagedNebula-macos-${{ steps.get_version.outputs.VERSION }}-signed.dmg`
          - Drag to Applications folder
          
          ## What's Included
          - Native macOS menu bar application
          - Nebula v1.9.7 binaries (PKG only)
          - Automatic configuration updates
          - Secure Keychain integration
          - LaunchDaemon for auto-start (PKG only)
          
          ## System Requirements
          - macOS 12 (Monterey) or later
          - Intel or Apple Silicon Mac
          
          ## Quick Start
          1. Install using PKG or DMG
          2. Launch ManagedNebula from Applications
          3. Enter your server URL and client token
          4. Connect!
          
          For detailed documentation, see the [README](https://github.com/kumpeapps/managed-nebula/blob/main/macos_client/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
