name: Build and Release macOS Client

on:
  push:
    branches:
      - '**'

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.MACOS_RELEASE_DEPLOY_KEY }}
      
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: macos_client
    
    - name: Install Fastlane
      run: |
        cd macos_client
        gem install fastlane
    
    - name: Setup SSH key for Fastlane Match
      env:
        MATCH_DEPLOY_KEY: ${{ secrets.MATCH_DEPLOY_KEY }}
      run: |
        # Setup SSH key for Match certificates repo
        mkdir -p ~/.ssh
        echo "$MATCH_DEPLOY_KEY" > ~/.ssh/match_deploy_key
        chmod 600 ~/.ssh/match_deploy_key
        
        # Add GitHub to known hosts
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        
        # Configure SSH to use the deploy key for Match repo
        cat >> ~/.ssh/config <<EOF
        Host github.com-match
          HostName github.com
          User git
          IdentityFile ~/.ssh/match_deploy_key
          IdentitiesOnly yes
        EOF
        
        # Configure git for match
        git config --global user.email "ci@kumpeapps.com"
        git config --global user.name "GitHub Actions"
    
    - name: Check if main branch
      id: branch_check
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "is_main=true" >> $GITHUB_OUTPUT
          echo "Running on main branch - will proceed with full build"
        else
          echo "is_main=false" >> $GITHUB_OUTPUT
          echo "Not on main branch - testing Match setup"
        fi
    
    - name: Test Fastlane Match Clone (non-main branches only)
      if: steps.branch_check.outputs.is_main == 'false'
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      run: |
        cd macos_client
        echo "Testing Match clone on non-main branch..."
        
        # Test SSH connection to Match repo
        GIT_SSH_COMMAND="ssh -i ~/.ssh/match_deploy_key -o IdentitiesOnly=yes" \
          git clone git@github.com:kumpeapps/fastlane_certs.git /tmp/test-certs-clone 2>&1 || {
          echo "❌ Failed to clone certificates repo"
          echo "Check MATCH_DEPLOY_KEY secret"
          exit 1
        }
        echo "✅ Successfully cloned certificates repo via SSH"
        rm -rf /tmp/test-certs-clone
    
    - name: Get version from release tag
      if: steps.branch_check.outputs.is_main == 'true'
      id: get_version
      run: |
        # Extract version from latest git tag or use commit SHA
        if git describe --tags --exact-match 2>/dev/null; then
          VERSION=$(git describe --tags --exact-match | sed 's/^v//')
        else
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "dev-$(git rev-parse --short HEAD)")
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Build and Sign with Fastlane
      if: steps.branch_check.outputs.is_main == 'true'
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
        MATCH_GIT_PRIVATE_KEY: ${{ secrets.MATCH_DEPLOY_KEY }}
        APPLE_APPSTORE_API_ISSUER_ID: ${{ secrets.APPLE_APPSTORE_API_ISSUER_ID }}
        APPLE_APP_STORE_API_KEY: ${{ secrets.APPLE_APP_STORE_API_KEY }}
        APPLE_APP_STORE_API_KEY_ID: ${{ secrets.APPLE_APP_STORE_API_KEY_ID }}
        VERSION: ${{ steps.get_version.outputs.VERSION }}
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_USER: "jakumpe@justinkumpe.net"

      run: |
        cd macos_client
        fastlane mac build_production
    
    - name: Verify notarization
      if: steps.branch_check.outputs.is_main == 'true'
      run: |
        cd macos_client
        spctl -a -vv -t install dist/ManagedNebula-${{ steps.get_version.outputs.VERSION }}-signed.pkg
        xcrun stapler validate dist/ManagedNebula-${{ steps.get_version.outputs.VERSION }}-signed.pkg
    
    - name: Upload to Release
      if: steps.branch_check.outputs.is_main == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          macos_client/dist/*-signed.pkg
          macos_client/dist/*-signed.dmg
        body: |
          # ManagedNebula macOS Client ${{ steps.get_version.outputs.VERSION }}
          
          ## Installation Options
          
          ### PKG Installer (Recommended)
          - Complete installation with Nebula binaries and LaunchDaemon
          - Download: `ManagedNebula-${{ steps.get_version.outputs.VERSION }}.pkg`
          - Double-click to install
          
          ### DMG Installer
          - For users who already have Nebula via Homebrew
          - Download: `ManagedNebula-${{ steps.get_version.outputs.VERSION }}.dmg`
          - Drag to Applications folder
          
          ## What's Included
          - Native macOS menu bar application
          - Nebula v1.8.2 binaries (PKG only)
          - Automatic configuration updates
          - Secure Keychain integration
          - LaunchDaemon for auto-start (PKG only)
          
          ## System Requirements
          - macOS 12 (Monterey) or later
          - Intel or Apple Silicon Mac
          
          ## Quick Start
          1. Install using PKG or DMG
          2. Launch ManagedNebula from Applications
          3. Enter your server URL and client token
          4. Connect!
          
          For detailed documentation, see the [README](https://github.com/kumpeapps/managed-nebula/blob/main/macos_client/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
