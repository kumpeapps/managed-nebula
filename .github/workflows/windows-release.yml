name: Build and Release Windows Client

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  build:
    # Run if title has "windows" (any case) or no platform keywords specified
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' &&
        (
          contains(github.event.release.name, 'windows') ||
          contains(github.event.release.name, 'Windows') ||
          (
            !contains(github.event.release.name, 'windows') &&
            !contains(github.event.release.name, 'Windows') &&
            !contains(github.event.release.name, 'macos') &&
            !contains(github.event.release.name, 'macOS') &&
            !contains(github.event.release.name, 'server') &&
            !contains(github.event.release.name, 'Server') &&
            !contains(github.event.release.name, 'frontend') &&
            !contains(github.event.release.name, 'Frontend') &&
            !contains(github.event.release.name, 'client') &&
            !contains(github.event.release.name, 'Client')
          )
        )
      )
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Get version from release tag
      id: get_version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "release") {
          $version = "${{ github.ref_name }}" -replace '^v', ''
        } else {
          $version = "${{ github.event.inputs.version }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pywin32 httpx pyyaml cryptography pystray Pillow
    
    - name: Download Nebula binaries
      shell: pwsh
      run: |
        $nebulaVersion = "1.9.7"
        $nebulaUrl = "https://github.com/slackhq/nebula/releases/download/v$nebulaVersion/nebula-windows-amd64.zip"
        $nebulaTmp = "windows_client\nebula-tmp"
        
        New-Item -ItemType Directory -Force -Path $nebulaTmp | Out-Null
        
        Write-Host "Downloading Nebula v$nebulaVersion..."
        Invoke-WebRequest -Uri $nebulaUrl -OutFile "$nebulaTmp\nebula.zip"
        
        Write-Host "Extracting Nebula binaries..."
        Expand-Archive -Path "$nebulaTmp\nebula.zip" -DestinationPath $nebulaTmp -Force
        
        if (!(Test-Path "$nebulaTmp\nebula.exe")) {
          throw "Failed to extract Nebula binaries"
        }
        
        Write-Host "Nebula binaries ready"
    
    - name: Update version in agent.py
      shell: pwsh
      run: |
        $agentPath = "windows_client\agent.py"
        $content = Get-Content $agentPath -Raw
        $content = $content -replace '__version__ = ".*"', "__version__ = `"${{ steps.get_version.outputs.VERSION }}`""
        Set-Content -Path $agentPath -Value $content
        Write-Host "Updated version to ${{ steps.get_version.outputs.VERSION }}"
    
    - name: Build Agent executable
      shell: pwsh
      working-directory: windows_client
      run: |
        Write-Host "Building NebulaAgent.exe..."
        pyinstaller --onefile `
          --name "NebulaAgent" `
          --icon="installer\nebula.ico" `
          --add-data "config.py;." `
          --hidden-import=win32timezone `
          --hidden-import=win32serviceutil `
          --hidden-import=win32service `
          --hidden-import=win32event `
          --hidden-import=servicemanager `
          agent.py
        
        if (!(Test-Path "dist\NebulaAgent.exe")) {
          throw "Agent build failed"
        }
        Write-Host "Agent executable built successfully"
    
    - name: Build Service executable
      shell: pwsh
      working-directory: windows_client
      run: |
        Write-Host "Building NebulaAgentService.exe with service.spec..."
        pyinstaller service.spec --clean --noconfirm
        
        if (!(Test-Path "dist\NebulaAgentService.exe")) {
          throw "Service build failed"
        }
        Write-Host "Service executable built successfully"
    
    - name: Build GUI executable
      shell: pwsh
      working-directory: windows_client
      run: |
        Write-Host "Building NebulaAgentGUI.exe..."
        pyinstaller --onefile --windowed `
          --name "NebulaAgentGUI" `
          --icon="installer\nebula.ico" `
          --add-data "config.py;." `
          --add-data "agent.py;." `
          --add-data "installer\nebula.ico;installer" `
          --hidden-import=win32timezone `
          --hidden-import=pystray._win32 `
          gui.py
        
        if (!(Test-Path "dist\NebulaAgentGUI.exe")) {
          throw "GUI build failed"
        }
        Write-Host "GUI executable built successfully"
    
    - name: Prepare distribution package
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $pkgDir = "windows_client\dist\NebulaAgent-$version"
        
        New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
        
        # Copy executables
        Copy-Item "windows_client\dist\NebulaAgent.exe" $pkgDir
        Copy-Item "windows_client\dist\NebulaAgentService.exe" $pkgDir
        Copy-Item "windows_client\dist\NebulaAgentGUI.exe" $pkgDir
        
        # Copy Nebula binaries
        Copy-Item "windows_client\nebula-tmp\nebula.exe" $pkgDir
        Copy-Item "windows_client\nebula-tmp\nebula-cert.exe" $pkgDir
        
        # Copy installer scripts
        Copy-Item "windows_client\installer\install.ps1" $pkgDir
        Copy-Item "windows_client\installer\uninstall.ps1" $pkgDir
        
        # Copy icon
        Copy-Item "windows_client\installer\nebula.ico" $pkgDir
        
        # Create version file
        Set-Content -Path "$pkgDir\VERSION" -Value $version
        
        # Create example config
        @"
        # Managed Nebula Agent Configuration
        [agent]
        server_url = https://your-server.example.com:8080
        client_token = your-client-token-here
        poll_interval_hours = 24
        log_level = INFO
        auto_start_nebula = true
        "@ | Set-Content -Path "$pkgDir\agent.ini.example"
        
        # Copy README
        Copy-Item "windows_client\README.md" $pkgDir
        
        Write-Host "Distribution package prepared at $pkgDir"
    
    - name: Create ZIP archive
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $pkgDir = "windows_client\dist\NebulaAgent-$version"
        $zipPath = "windows_client\dist\NebulaAgent-windows-$version.zip"
        
        Compress-Archive -Path "$pkgDir\*" -DestinationPath $zipPath -Force
        
        Write-Host "Created: $zipPath"
        Get-Item $zipPath | Format-List Name, Length
    
    - name: Install NSIS
      shell: pwsh
      run: |
        choco install nsis -y
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
    
    - name: Build NSIS Installer
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $pkgDir = "windows_client\dist\NebulaAgent-$version"
        $installerDir = "windows_client\installer"
        
        # Copy all files to installer directory for NSIS
        Copy-Item "$pkgDir\NebulaAgent.exe" $installerDir
        Copy-Item "$pkgDir\NebulaAgentService.exe" $installerDir
        Copy-Item "$pkgDir\NebulaAgentGUI.exe" $installerDir
        Copy-Item "$pkgDir\nebula.exe" $installerDir
        Copy-Item "$pkgDir\nebula-cert.exe" $installerDir
        Copy-Item "$pkgDir\README.md" $installerDir
        Copy-Item "$pkgDir\agent.ini.example" $installerDir
        
        # Build installer
        cd $installerDir
        & "C:\Program Files (x86)\NSIS\makensis.exe" /DVERSION=$version installer.nsi
        
        if (!(Test-Path "ManagedNebula-$version-Setup.exe")) {
          throw "NSIS build failed"
        }
        
        # Move installer to dist directory
        Move-Item "ManagedNebula-$version-Setup.exe" "..\dist\"
        
        Write-Host "Created: ManagedNebula-$version-Setup.exe"
        Get-Item "..\dist\ManagedNebula-$version-Setup.exe" | Format-List Name, Length
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: NebulaAgent-windows-${{ steps.get_version.outputs.VERSION }}
        path: |
          windows_client/dist/ManagedNebula-${{ steps.get_version.outputs.VERSION }}-Setup.exe
          windows_client/dist/NebulaAgent-windows-${{ steps.get_version.outputs.VERSION }}.zip
        retention-days: 30
    
    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          windows_client/dist/ManagedNebula-${{ steps.get_version.outputs.VERSION }}-Setup.exe
          windows_client/dist/NebulaAgent-windows-${{ steps.get_version.outputs.VERSION }}.zip
        append_body: true
        body: |
          # Managed Nebula Windows Client ${{ steps.get_version.outputs.VERSION }}
          
          ## Installation
          
          ### Option 1: Installer (Recommended)
          1. Download `ManagedNebula-${{ steps.get_version.outputs.VERSION }}-Setup.exe`
          2. Run the installer as Administrator
          3. Follow the installation wizard
          4. Launch from Start Menu or Desktop shortcut
          5. Configure your server URL and client token in the GUI
          
          ### Option 2: ZIP Archive
          1. Download and extract `NebulaAgent-windows-${{ steps.get_version.outputs.VERSION }}.zip`
          2. Right-click `install.ps1` and select "Run with PowerShell" as Administrator
          3. Run `NebulaAgentGUI.exe` to configure
          
          ## Package Contents
          - `NebulaAgent.exe` - Agent CLI tool
          - `NebulaAgentService.exe` - Windows Service (background)
          - `NebulaAgentGUI.exe` - GUI Configuration App (system tray)
          - `nebula.exe` - Nebula VPN binary (v1.9.7)
          - `nebula-cert.exe` - Nebula certificate tool
          
          ## System Requirements
          - Windows 10/11 or Windows Server 2019/2022
          - Administrator privileges for installation
          
          ## Features
          - System tray icon showing connection status
          - Automatic Windows Service for background operation
          - GUI for easy configuration
          - Automatic certificate rotation
          - Version reporting to server
          
          For detailed documentation, see the [README](https://github.com/kumpeapps/managed-nebula/blob/main/windows_client/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
