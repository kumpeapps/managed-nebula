name: Auto Rebase Branches

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to rebase (leave empty to use config)'
        required: false
        type: string

jobs:
  rebase:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.KUMPEAPPS_REBASEBOT_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Read rebase configuration
        id: config
        run: |
          if [ -f .github/auto-rebase.yml ]; then
            echo "Config file found, reading branch mappings..."
            
            # Parse YAML and extract branch pairs
            # Format: source_branch: [target_branch1, target_branch2]
            python3 << 'EOF'
          import yaml
          import json
          import sys
          
          try:
              with open('.github/auto-rebase.yml', 'r') as f:
                  config = yaml.safe_load(f)
              
              # Get the source branch (current branch that triggered the workflow)
              source_branch = "${{ github.ref_name }}"
              
              # Get manual override if provided
              manual_target = "${{ github.event.inputs.target_branch }}"
              
              if manual_target:
                  print(f"branches={manual_target}")
              elif 'rebase_branches' in config and source_branch in config['rebase_branches']:
                  targets = config['rebase_branches'][source_branch]
                  if isinstance(targets, list):
                      branches = ','.join(targets)
                  else:
                      branches = targets
                  print(f"branches={branches}")
              else:
                  print(f"branches=")
                  
          except Exception as e:
              print(f"Error reading config: {e}", file=sys.stderr)
              print("branches=")
          EOF
          } >> "$GITHUB_OUTPUT"
      
      - name: Rebase target branches
        if: steps.config.outputs.branches != ''
        run: |
          SOURCE_BRANCH="${{ github.ref_name }}"
          TARGET_BRANCHES="${{ steps.config.outputs.branches }}"
          
          echo "Source branch: $SOURCE_BRANCH"
          echo "Target branches: $TARGET_BRANCHES"
          
          # Split comma-separated branches
          IFS=',' read -ra BRANCHES <<< "$TARGET_BRANCHES"
          
          for TARGET_BRANCH in "${BRANCHES[@]}"; do
            TARGET_BRANCH=$(echo "$TARGET_BRANCH" | xargs) # trim whitespace
            
            echo "================================================"
            echo "Rebasing $TARGET_BRANCH onto $SOURCE_BRANCH"
            echo "================================================"
            
            # Fetch latest
            git fetch origin "$TARGET_BRANCH" || {
              echo "❌ Failed to fetch $TARGET_BRANCH"
              continue
            }
            
            # Checkout target branch
            git checkout "$TARGET_BRANCH" || {
              echo "❌ Failed to checkout $TARGET_BRANCH"
              continue
            }
            
            # Attempt rebase
            if git rebase "origin/$SOURCE_BRANCH"; then
              echo "✅ Rebase successful for $TARGET_BRANCH"
              
              # Push with force-with-lease to protect against race conditions
              if git push origin "$TARGET_BRANCH" --force-with-lease; then
                echo "✅ Successfully pushed $TARGET_BRANCH"
              else
                echo "❌ Failed to push $TARGET_BRANCH"
                git rebase --abort 2>/dev/null || true
              fi
            else
              echo "❌ Rebase failed for $TARGET_BRANCH (conflicts detected)"
              git rebase --abort
              
              # Create an issue to notify about the conflict
              gh issue create \
                --title "Auto-rebase failed: $TARGET_BRANCH conflicts with $SOURCE_BRANCH" \
                --body "Automatic rebase of \`$TARGET_BRANCH\` onto \`$SOURCE_BRANCH\` failed due to conflicts.

              **Action Required:**
              Please manually rebase \`$TARGET_BRANCH\` and resolve conflicts:
              
              \`\`\`bash
              git checkout $TARGET_BRANCH
              git fetch origin
              git rebase origin/$SOURCE_BRANCH
              # Resolve conflicts
              git rebase --continue
              git push origin $TARGET_BRANCH --force-with-lease
              \`\`\`
              
              **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
                --label "auto-rebase-conflict" \
                || echo "Failed to create issue (may already exist)"
            fi
            
            # Return to source branch
            git checkout "$SOURCE_BRANCH"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        if: always()
        run: |
          echo "## Auto-rebase Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Branches:** ${{ steps.config.outputs.branches }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered By:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "${{ steps.config.outputs.branches }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ No target branches configured for ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Add branch mappings to \`.github/auto-rebase.yml\`" >> $GITHUB_STEP_SUMMARY
          fi
