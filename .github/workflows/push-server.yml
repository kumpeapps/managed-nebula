name: Push Server Image to Harbor
permissions:
  contents: read

on:
  push:
    branches: [ dev, main ]
    tags: [ 'v*' ]
    paths:
      - 'server/**'
      - 'docker-compose.yml'
      - '.github/workflows/push-server.yml'
  workflow_dispatch:

env:
  DOCKER_CLIENT_TIMEOUT: 300
  COMPOSE_HTTP_TIMEOUT: 300

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push-server:
    timeout-minutes: 120
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Preflight- Harbor DNS and TLS reachability
        run: |
          set -x
          getent hosts harbor.vm.kumpeapps.com || true
          nslookup harbor.vm.kumpeapps.com || true
          curl -vkI --max-time 15 https://harbor.vm.kumpeapps.com/v2/ || true

      - name: Set up QEMU (multi-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Harbor (with retry)
        run: |
          for i in 1 2 3; do
            echo "${{ secrets.HARBOR_SECRET }}" | docker login harbor.vm.kumpeapps.com -u "robot_github" --password-stdin && exit 0
            echo "Login failed (attempt $i), retrying in 5s...";
            sleep 5;
          done
          echo "Failed to login to Harbor after 3 attempts" >&2
          exit 1

      - name: Get Latest Release Version
        id: get_version
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Current branch: ${BRANCH_NAME}"
          
          # Fetch all releases and find the most recent one for this branch
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/kumpeapps/managed-nebula/releases | \
            jq -r --arg branch "$BRANCH_NAME" '[
              .[] | select(.target_commitish == $branch or .target_commitish == "main")
            ] | .[0].tag_name // "v1.0.0"')
          
          echo "latest_version=${LATEST_RELEASE}" >> $GITHUB_OUTPUT
          echo "Latest release version for ${BRANCH_NAME}: ${LATEST_RELEASE}"

      - name: Build and Push Image (dev-latest)
        if: github.ref == 'refs/heads/dev'
        run: |
          docker buildx build --push \
            --build-arg VERSION=${{ steps.get_version.outputs.latest_version }} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/server:dev-latest \
            --cache-from type=gha,scope=server-dev \
            --cache-to type=gha,mode=max,scope=server-dev \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/server:dev-latest \
            --provenance=false \
            --platform linux/amd64,linux/arm64 ./server

      - name: Build and Push Image (latest)
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx build --push \
            --build-arg VERSION=${{ steps.get_version.outputs.latest_version }} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/server:latest \
            --cache-from type=gha,scope=server-main \
            --cache-to type=gha,mode=max,scope=server-main \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/server:latest \
            --provenance=false \
            --platform linux/amd64,linux/arm64 ./server

      - name: Build and Push Image (tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          docker buildx build --push \
            --build-arg VERSION=${GITHUB_REF#refs/tags/} \
            --tag harbor.vm.kumpeapps.com/managed-nebula/server:${GITHUB_REF#refs/tags/} \
            --cache-from type=gha,scope=server-main \
            --cache-to type=gha,mode=max,scope=server-tag \
            --cache-from type=registry,ref=harbor.vm.kumpeapps.com/managed-nebula/server:latest \
            --provenance=false \
            --platform linux/amd64,linux/arm64 ./server
